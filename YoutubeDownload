# coding: utf8
from pyrogram.handlers import MessageHandler
import time
from pyrogram import Client,  filters
import logging
import requests
import youtube_dl 
import random
import os
import re
logging.basicConfig(level=logging.INFO)
bot = Client(
    "ses1",
    api_id=16843888, 
    api_hash="9b8f079b171065416de8cf91595c1d95",
  workers = 5, 
  bot_token='5795651353:AAFSl_nST34CxLPNDwwAzZWytjqjVQyzmMw'
)

def to_valid(url, VID_ID):
    youtube_urls_test = ['']
    youtube_urls_test.pop(0)
    youtube_urls_test.append(url)
    youtube_regex = (
        r'(https?://)?(www\.)?'
        '(youtube|youtu|youtube-nocookie)\.(com|be)/'
        '(watch\?v=|embed/|v/|.+\?v=)?([^&=%\?]{11})')
    youtube_regex_match = re.match(youtube_regex, url)
    VID_ID = youtube_regex_match.group(6)
    if youtube_regex_match != None:
        return VID_ID
    else:
        raise Exception('NOT_VALID_URL')



def worker(VID_ID):

	ydl_opts = {
		'max_filesize': 20000000000,
		'format': 'best',
		'outtmpl': VID_ID + '.mp4',
		'output': VID_ID + '.mp4',
		'quiet': True
	}
	with youtube_dl.YoutubeDL(ydl_opts) as ydl:
		ydl.download([VID_ID])
	return VID_ID






@bot.on_message(filters.command("start", ["!", "/"]))
def connect(chat, m):
	try:
		userID = m.chat.id
		bot.send_message(userID, 'Salom aleykum Bratan nima xizmat oka oxoxlasez YouTubedan video tashang man skachat qilib beray')
	except Exception as e:
		print(e)


@bot.on_message(filters.text)
def get(chat, m):
	url=m.text	
	userID = m.chat.id
	try:
		VID_ID = ''
		VID_ID = to_valid(url, VID_ID) #валидация регуляркой из validation.py
		bot.send_message(m.chat.id, 'Brat ixtiyoriz blan bowladm Skachat qlishni')
		worker(VID_ID) #скачивание видео
		bot.send_video(m.chat.id, str(VID_ID) + '.mp4', '@YoutubeDownloader_ro_bot\nBiz Nomer 1 Turamiz brat') #отправляем видео пользователю
		os.remove(VID_ID + '.mp4') #удаляем видео на диске в целях жкономии места
	except Exception as e:
		bot.send_message(m.chat.id, f'brat uzur endi bu videoni qilomadm `{e}`')	


bot.run()	
